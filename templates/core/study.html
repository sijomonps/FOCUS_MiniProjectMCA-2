{% extends 'base.html' %}
{% load static %}

{% block title %}Focus Timer - FOCUS{% endblock %}

{% block extra_css %}
<style>
    /* Ultra Minimal Timer Layout */
    .timer-page {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: calc(100vh - 100px);
        padding: 2rem;
    }

    /* Duration Presets */
    .duration-presets {
        display: flex;
        gap: 12px;
        margin-bottom: 3rem;
        flex-wrap: wrap;
        justify-content: center;
    }

    .preset-btn {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
        padding: 12px 24px;
        border-radius: 50px;
        font-size: 0.95rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .preset-btn:hover {
        border-color: var(--text-secondary);
        color: var(--text-primary);
    }

    .preset-btn.active {
        background: var(--text-primary);
        color: var(--bg-primary);
        border-color: var(--text-primary);
    }

    .preset-btn.custom-active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    /* Custom Duration Input */
    .custom-input-wrapper {
        display: none;
        align-items: center;
        gap: 8px;
        margin-top: 1rem;
    }

    .custom-input-wrapper.show {
        display: flex;
    }

    .custom-input {
        width: 80px;
        padding: 10px 16px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 25px;
        color: var(--text-primary);
        font-size: 1rem;
        text-align: center;
    }

    .custom-input:focus {
        outline: none;
        border-color: var(--primary-color);
    }

    .custom-label {
        color: var(--text-secondary);
        font-size: 0.9rem;
    }

    /* Timer Display */
    .timer-display {
        font-size: 8rem;
        font-weight: 200;
        color: var(--text-primary);
        font-variant-numeric: tabular-nums;
        line-height: 1;
        margin-bottom: 1rem;
        letter-spacing: -4px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    }

    .timer-mode-label {
        color: var(--text-tertiary);
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 2px;
        margin-bottom: 2rem;
    }

    @media (max-width: 768px) {
        .timer-display {
            font-size: 4.5rem;
            letter-spacing: -2px;
        }

        .timer-page {
            min-height: calc(100vh - 150px);
            padding: 1rem;
        }

        .duration-presets {
            gap: 8px;
        }

        .preset-btn {
            padding: 10px 18px;
            font-size: 0.85rem;
        }
    }

    /* Subject Select - Minimal */
    .subject-select-wrapper {
        margin-bottom: 2rem;
        width: 100%;
        max-width: 280px;
    }

    .subject-select {
        width: 100%;
        padding: 14px 24px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 50px;
        color: var(--text-primary);
        font-size: 1rem;
        cursor: pointer;
        appearance: none;
        text-align: center;
        transition: all 0.2s;
    }

    .subject-select:focus {
        outline: none;
        border-color: var(--primary-color);
    }

    .subject-select option {
        background: var(--bg-secondary);
        color: var(--text-primary);
    }

    /* Control Buttons */
    .controls {
        display: flex;
        gap: 16px;
        align-items: center;
    }

    .main-btn {
        background: var(--text-primary);
        color: var(--bg-primary);
        border: none;
        padding: 18px 56px;
        font-size: 1rem;
        font-weight: 600;
        border-radius: 50px;
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 2px;
        transition: all 0.2s ease;
    }

    .main-btn:hover {
        transform: scale(1.02);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    }

    .main-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    .main-btn.running {
        background: var(--color-red);
        color: white;
    }

    .reset-btn {
        background: transparent;
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
        padding: 18px 32px;
        font-size: 0.9rem;
        font-weight: 500;
        border-radius: 50px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .reset-btn:hover {
        border-color: var(--text-secondary);
        color: var(--text-primary);
    }

    /* Session Complete Message */
    .session-complete {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.85);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        flex-direction: column;
        gap: 24px;
    }

    .session-complete.show {
        display: flex;
    }

    .session-complete h2 {
        font-size: 2.5rem;
        font-weight: 300;
        color: var(--text-primary);
    }

    .session-complete p {
        color: var(--text-secondary);
        font-size: 1.1rem;
    }

    .session-complete button {
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 16px 48px;
        font-size: 1rem;
        border-radius: 50px;
        cursor: pointer;
        margin-top: 1rem;
    }

    /* Recorded Sessions - Minimal */
    .recorded-info {
        position: fixed;
        bottom: 2rem;
        left: 50%;
        transform: translateX(-50%);
        color: var(--text-tertiary);
        font-size: 0.8rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .recorded-dot {
        width: 6px;
        height: 6px;
        background: var(--color-green);
        border-radius: 50%;
    }

    /* Today's Study Time Indicator */
    .today-study-indicator {
        position: fixed;
        top: 1.5rem;
        right: 1.5rem;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        padding: 10px 16px;
        border-radius: 50px;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
        color: var(--text-secondary);
        box-shadow: var(--shadow-md);
        z-index: 100;
    }

    .today-study-indicator i {
        color: var(--color-green);
        font-size: 1.1rem;
    }

    .today-study-indicator span:last-child {
        color: var(--color-green);
        font-weight: 600;
    }

    @media (max-width: 768px) {
        .today-study-indicator {
            top: auto;
            bottom: 5rem;
            right: 1rem;
            padding: 8px 12px;
            font-size: 0.8rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="timer-page fade-in">

    <!-- Duration Presets -->
    <div class="duration-presets">
        <button class="preset-btn" data-duration="25" onclick="selectDuration(25, this)">25 min</button>
        <button class="preset-btn" data-duration="45" onclick="selectDuration(45, this)">45 min</button>
        <button class="preset-btn" data-duration="60" onclick="selectDuration(60, this)">60 min</button>
        <button class="preset-btn" data-duration="90" onclick="selectDuration(90, this)">90 min</button>
        <button class="preset-btn" data-duration="custom" onclick="toggleCustomInput(this)">Custom</button>
    </div>

    <!-- Custom Duration Input -->
    <div class="custom-input-wrapper" id="customInputWrapper">
        <input type="number" class="custom-input" id="customMinutes" min="1" max="180" placeholder="30">
        <span class="custom-label">minutes</span>
        <button class="preset-btn" onclick="applyCustomDuration()" style="padding: 10px 20px;">Set</button>
    </div>

    <!-- Timer Display -->
    <div class="timer-display" id="timerDisplay">25:00</div>
    <div class="timer-mode-label" id="timerModeLabel">Focus Session</div>

    <!-- Subject Select -->
    <div class="subject-select-wrapper">
        <select class="subject-select" id="subjectSelect">
            <option value="" disabled selected>Select subject...</option>
            {% for subject in subjects %}
            <option value="{{ subject }}">{{ subject }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- Controls -->
    <div class="controls">
        <button class="main-btn" id="mainBtn" onclick="toggleTimer()">Start</button>
        <button class="reset-btn" id="resetBtn" onclick="resetTimer()">Reset</button>
    </div>

</div>

<!-- Session Complete Overlay -->
<div class="session-complete" id="sessionComplete">
    <h2>ðŸŽ‰ Session Complete!</h2>
    <p id="sessionSummary">You focused for 25 minutes</p>
    <button onclick="closeComplete()">Continue</button>
</div>

<!-- Recorded Sessions Indicator -->
<div class="recorded-info" id="recordedInfo" style="display: none;">
    <span class="recorded-dot"></span>
    <span id="recordedText">Session recorded</span>
</div>

<!-- Today's Study Time Indicator (Study Page) -->
<div class="today-study-indicator" id="todayStudyIndicator">
    <i class="mdi mdi-clock-check-outline"></i>
    <span>Today: </span>
    <span id="todayStudyTime">0m</span>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Timer Configuration
    let selectedDuration = 25 * 60; // Default 25 minutes in seconds
    let remainingTime = selectedDuration;
    let timerInterval = null;
    let isRunning = false;
    let sessionStartTime = null;
    let totalFocusedTime = 0;
    let timerEndTime = null; // Timestamp when timer should end

    // DOM Elements
    const timerDisplay = document.getElementById('timerDisplay');
    const timerModeLabel = document.getElementById('timerModeLabel');
    const mainBtn = document.getElementById('mainBtn');
    const resetBtn = document.getElementById('resetBtn');
    const subjectSelect = document.getElementById('subjectSelect');
    const customInputWrapper = document.getElementById('customInputWrapper');
    const customMinutesInput = document.getElementById('customMinutes');
    const sessionComplete = document.getElementById('sessionComplete');
    const sessionSummary = document.getElementById('sessionSummary');
    const recordedInfo = document.getElementById('recordedInfo');
    const globalTimerContainer = document.getElementById('globalTimerContainer');
    const globalTimerDisplay = document.getElementById('globalTimerDisplay');

    // ========================================
    // Today's Study Time Helper Functions
    // ========================================
    function getTodayDateKey() {
        const now = new Date();
        return `studyTime_${now.getFullYear()}_${now.getMonth()}_${now.getDate()}`;
    }

    function getTodayStudyMinutes() {
        const key = getTodayDateKey();
        const saved = localStorage.getItem(key);
        return saved ? parseInt(saved) : 0;
    }

    function addTodayStudyMinutes(minutes) {
        const key = getTodayDateKey();
        const current = getTodayStudyMinutes();
        const newTotal = current + minutes;
        localStorage.setItem(key, newTotal.toString());

        // Clean up old entries
        cleanupOldStudyData();

        // Update the display in sidebar
        updateTodayStudyDisplay();

        return newTotal;
    }

    function cleanupOldStudyData() {
        const todayKey = getTodayDateKey();
        const keysToRemove = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.startsWith('studyTime_') && key !== todayKey) {
                keysToRemove.push(key);
            }
        }
        keysToRemove.forEach(key => localStorage.removeItem(key));
    }

    function formatStudyTime(minutes) {
        const hours = Math.floor(minutes / 60);
        const mins = minutes % 60;
        if (hours > 0) {
            return `${hours}h ${mins}m`;
        }
        return `${mins}m`;
    }

    function updateTodayStudyDisplay() {
        const savedMinutes = getTodayStudyMinutes();

        // Calculate active session time if timer is running or paused with progress
        let activeSessionMinutes = 0;
        if (isRunning && timerEndTime && selectedDuration) {
            // Timer is running - calculate elapsed time
            const now = Date.now();
            const remaining = Math.max(0, Math.floor((timerEndTime - now) / 1000));
            const elapsed = selectedDuration - remaining;
            activeSessionMinutes = Math.floor(elapsed / 60);
        } else if (!isRunning && totalFocusedTime > 0) {
            // Timer is paused - use accumulated totalFocusedTime
            activeSessionMinutes = Math.floor(totalFocusedTime / 60);
        }

        const totalMinutes = savedMinutes + activeSessionMinutes;
        const formattedTime = formatStudyTime(totalMinutes);

        // Update sidebar display
        const sidebarDisplay = document.getElementById('todayStudyDisplay');
        if (sidebarDisplay) {
            sidebarDisplay.textContent = formattedTime;
        }

        // Update study page indicator with live tracking
        const pageIndicator = document.getElementById('todayStudyTime');
        const todayIndicator = document.getElementById('todayStudyIndicator');
        if (pageIndicator) {
            pageIndicator.textContent = formattedTime;

            // Add visual indicator when timer is active or paused with progress
            if (todayIndicator && (isRunning || totalFocusedTime > 0)) {
                todayIndicator.style.borderColor = isRunning ? 'var(--color-green)' : 'var(--color-yellow)';
                todayIndicator.style.boxShadow = isRunning
                    ? '0 0 12px rgba(102, 153, 119, 0.3)'
                    : '0 0 12px rgba(204, 187, 102, 0.3)';
            } else if (todayIndicator) {
                todayIndicator.style.borderColor = '';
                todayIndicator.style.boxShadow = '';
            }
        }
    }

    // Save timer state to localStorage for persistence across pages
    function saveTimerState() {
        const state = {
            isRunning: isRunning,
            timerEndTime: timerEndTime,
            selectedDuration: selectedDuration,
            remainingTime: remainingTime,
            subject: subjectSelect.value,
            totalFocusedTime: totalFocusedTime,
            sessionStartTime: sessionStartTime
        };
        localStorage.setItem('focusTimerState', JSON.stringify(state));
    }

    // Load timer state from localStorage
    function loadTimerState() {
        const savedState = localStorage.getItem('focusTimerState');
        if (savedState) {
            try {
                const state = JSON.parse(savedState);
                if (state.isRunning && state.timerEndTime) {
                    const now = Date.now();
                    const remaining = Math.floor((state.timerEndTime - now) / 1000);

                    if (remaining > 0) {
                        // Timer still running - restore state
                        isRunning = true;
                        timerEndTime = state.timerEndTime;
                        selectedDuration = state.selectedDuration;
                        remainingTime = remaining;
                        totalFocusedTime = state.totalFocusedTime || 0;
                        sessionStartTime = state.sessionStartTime;

                        // Restore subject selection
                        if (state.subject) {
                            subjectSelect.value = state.subject;
                            subjectSelect.disabled = true;
                        }

                        // Update UI
                        mainBtn.textContent = 'Pause';
                        mainBtn.classList.add('running');
                        timerModeLabel.textContent = 'Focusing...';

                        // Update display immediately
                        updateDisplay();
                        updateGlobalTimer();

                        // Restart the timer loop
                        startTimerLoop();
                        return true;
                    } else {
                        // Timer has ended while away
                        if (state.subject) {
                            subjectSelect.value = state.subject;
                            selectedDuration = state.selectedDuration;
                            totalFocusedTime = state.selectedDuration;
                            remainingTime = 0;
                            timerComplete();
                        }
                        clearTimerState();
                    }
                } else if (!state.isRunning && state.subject) {
                    // Timer was paused - restore paused state
                    selectedDuration = state.selectedDuration || selectedDuration;
                    remainingTime = state.remainingTime || selectedDuration;
                    subjectSelect.value = state.subject;
                    totalFocusedTime = state.totalFocusedTime || 0;

                    if (totalFocusedTime > 0) {
                        mainBtn.textContent = 'Resume';
                        timerModeLabel.textContent = 'Paused';
                    }
                    updateDisplay();
                }
            } catch (e) {
                console.error('Error loading timer state:', e);
                clearTimerState();
            }
        }
        return false;
    }

    // Clear timer state
    function clearTimerState() {
        localStorage.removeItem('focusTimerState');
    }

    // Update global sidebar timer - sync with base.html's global timer
    function updateGlobalTimer() {
        // This triggers the global timer in base.html to update by re-saving state
        // The base.html interval will pick up the changes
        if (globalTimerContainer && globalTimerDisplay) {
            if (isRunning && remainingTime > 0) {
                globalTimerContainer.classList.remove('hidden');
                globalTimerDisplay.textContent = formatTime(remainingTime);
            } else {
                globalTimerContainer.classList.add('hidden');
            }
        }
    }

    // Format time as MM:SS
    function formatTime(seconds) {
        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        return `${m}:${s < 10 ? '0' : ''}${s}`;
    }

    // Select Duration Preset
    function selectDuration(minutes, btn) {
        if (isRunning) return;

        // Update button states
        document.querySelectorAll('.preset-btn').forEach(b => {
            b.classList.remove('active', 'custom-active');
        });
        btn.classList.add('active');

        // Hide custom input
        customInputWrapper.classList.remove('show');

        // Set duration
        selectedDuration = minutes * 60;
        remainingTime = selectedDuration;
        updateDisplay();
    }

    // Toggle Custom Input
    function toggleCustomInput(btn) {
        if (isRunning) return;

        document.querySelectorAll('.preset-btn').forEach(b => {
            b.classList.remove('active');
        });

        customInputWrapper.classList.toggle('show');

        if (customInputWrapper.classList.contains('show')) {
            btn.classList.add('custom-active');
            customMinutesInput.focus();
        } else {
            btn.classList.remove('custom-active');
        }
    }

    // Apply Custom Duration
    function applyCustomDuration() {
        const minutes = parseInt(customMinutesInput.value);
        if (minutes && minutes > 0 && minutes <= 180) {
            selectedDuration = minutes * 60;
            remainingTime = selectedDuration;
            updateDisplay();
            customInputWrapper.classList.remove('show');
        }
    }

    // Update Timer Display
    function updateDisplay() {
        timerDisplay.textContent = formatTime(remainingTime);

        if (isRunning) {
            document.title = `(${formatTime(remainingTime)}) Focus - FOCUS`;
        } else {
            document.title = 'Focus Timer - FOCUS';
        }
    }

    // Toggle Timer (Start/Pause)
    function toggleTimer() {
        console.log('toggleTimer called');
        console.log('Subject selected:', subjectSelect.value);
        console.log('Is running:', isRunning);

        if (!subjectSelect.value) {
            alert('Please select a subject before starting.');
            return;
        }

        if (isRunning) {
            console.log('Pausing timer');
            pauseTimer();
        } else {
            console.log('Starting timer');
            startTimer();
        }
    }

    // Start Timer
    function startTimer() {
        if (remainingTime <= 0) {
            remainingTime = selectedDuration;
        }

        isRunning = true;
        sessionStartTime = Date.now();
        timerEndTime = Date.now() + (remainingTime * 1000); // Calculate end time
        mainBtn.textContent = 'Pause';
        mainBtn.classList.add('running');
        timerModeLabel.textContent = 'Focusing...';
        subjectSelect.disabled = true;

        saveTimerState();
        startTimerLoop();
    }

    // Timer loop using timestamp-based calculation (works even when tab is inactive)
    function startTimerLoop() {
        clearInterval(timerInterval);

        timerInterval = setInterval(() => {
            const now = Date.now();
            remainingTime = Math.max(0, Math.floor((timerEndTime - now) / 1000));
            updateDisplay();
            updateGlobalTimer();
            updateTodayStudyDisplay(); // Live update today's study time
            saveTimerState();

            if (remainingTime <= 0) {
                timerComplete();
            }
        }, 100); // Update more frequently for accuracy
    }

    // Pause Timer
    function pauseTimer() {
        clearInterval(timerInterval);
        isRunning = false;
        timerEndTime = null;
        mainBtn.textContent = 'Resume';
        mainBtn.classList.remove('running');
        timerModeLabel.textContent = 'Paused';

        // Calculate focused time so far
        if (sessionStartTime) {
            totalFocusedTime += Math.floor((Date.now() - sessionStartTime) / 1000);
            sessionStartTime = null;
        }

        saveTimerState();
        updateGlobalTimer();
        updateTodayStudyDisplay(); // Keep today's study time updated when paused
    }

    // Reset Timer
    function resetTimer() {
        clearInterval(timerInterval);
        isRunning = false;
        timerEndTime = null;

        // Save session if any time was focused
        const focusedMinutes = Math.floor(totalFocusedTime / 60);
        if (focusedMinutes >= 1 && subjectSelect.value) {
            saveSession(focusedMinutes);
        }

        // Reset everything
        remainingTime = selectedDuration;
        totalFocusedTime = 0;
        sessionStartTime = null;
        mainBtn.textContent = 'Start';
        mainBtn.classList.remove('running');
        timerModeLabel.textContent = 'Focus Session';
        subjectSelect.disabled = false;
        updateDisplay();
        clearTimerState();
        updateGlobalTimer();
    }

    // Timer Complete
    function timerComplete() {
        clearInterval(timerInterval);
        isRunning = false;
        timerEndTime = null;

        // Calculate total focused time
        if (sessionStartTime) {
            totalFocusedTime += Math.floor((Date.now() - sessionStartTime) / 1000);
            sessionStartTime = null;
        }

        // Use selected duration if totalFocusedTime is 0 (timer completed normally)
        if (totalFocusedTime === 0) {
            totalFocusedTime = selectedDuration;
        }

        const focusedMinutes = Math.floor(totalFocusedTime / 60);

        // Play completion sound
        playCompletionSound();

        // Show browser notification
        showNotification(focusedMinutes);

        // Save the session
        if (focusedMinutes >= 1) {
            saveSession(focusedMinutes);
        }

        // Show completion overlay
        sessionSummary.textContent = `You focused for ${focusedMinutes} minutes on ${subjectSelect.value}`;
        sessionComplete.classList.add('show');

        // Reset for next session
        mainBtn.textContent = 'Start';
        mainBtn.classList.remove('running');
        timerModeLabel.textContent = 'Session Complete!';
        subjectSelect.disabled = false;
        remainingTime = selectedDuration;
        totalFocusedTime = 0;
        updateDisplay();
        clearTimerState();
        updateGlobalTimer();
    }

    // Play Completion Sound - Gentle 3-tone chime
    function playCompletionSound() {
        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();

            // Play 3 gentle ascending tones
            const frequencies = [523.25, 659.25, 783.99]; // C5, E5, G5
            const delays = [0, 200, 400];

            frequencies.forEach((freq, i) => {
                setTimeout(() => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    oscillator.frequency.value = freq;
                    oscillator.type = 'sine';
                    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.6);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.6);
                }, delays[i]);
            });
        } catch (e) {
            console.log('Audio not supported');
        }
    }

    // Show Browser Notification
    function showNotification(minutes) {
        if ('Notification' in window && Notification.permission === 'granted') {
            new Notification('Focus Session Complete! ðŸŽ‰', {
                body: `Great job! You focused for ${minutes} minutes.`,
                requireInteraction: true
            });
        }
    }

    // Request notification permission on load
    function requestNotificationPermission() {
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
    }

    // Save Session to Backend
    async function saveSession(minutes) {
        const subject = subjectSelect.value;
        if (!subject || minutes < 1) return;

        try {
            const response = await fetch("{% url 'save_study_session' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    subject: subject,
                    duration: minutes
                })
            });

            if (response.ok) {
                showRecordedIndicator();
                // Add to today's study time tracker
                const totalToday = addTodayStudyMinutes(minutes);
                console.log(`Session saved: ${minutes} min. Total today: ${totalToday} min`);
            }
        } catch (e) {
            console.error('Failed to save session:', e);
        }
    }

    // Show Recorded Indicator
    function showRecordedIndicator() {
        recordedInfo.style.display = 'flex';
        setTimeout(() => {
            recordedInfo.style.display = 'none';
        }, 3000);
    }

    // Close Completion Overlay
    function closeComplete() {
        sessionComplete.classList.remove('show');
    }

    // Handle Enter key in custom input
    customMinutesInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            applyCustomDuration();
        }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        if (e.code === 'Space' && !e.target.matches('input, select')) {
            e.preventDefault();
            toggleTimer();
        }
        if (e.code === 'Escape') {
            closeComplete();
        }
    });

    // Save state before leaving - DON'T pause, just ensure state is saved
    window.addEventListener('beforeunload', () => {
        if (isRunning) {
            // Just save the current state - timer will continue based on timerEndTime
            saveTimerState();
        }
    });

    // Also save when navigating within the app (click on sidebar links)
    document.querySelectorAll('.sidebar-nav a').forEach(link => {
        link.addEventListener('click', () => {
            if (isRunning) {
                saveTimerState();
            }
        });
    });

    // Initialize
    requestNotificationPermission();

    // Initialize today's study time display
    updateTodayStudyDisplay();

    // Try to restore timer state first
    const restored = loadTimerState();
    if (!restored) {
        updateDisplay();
        // Set first preset as active
        document.querySelector('.preset-btn[data-duration="25"]').classList.add('active');
    } else {
        // Update preset buttons to show correct selection
        document.querySelectorAll('.preset-btn').forEach(b => {
            b.classList.remove('active', 'custom-active');
            if (parseInt(b.dataset.duration) * 60 === selectedDuration) {
                b.classList.add('active');
            }
        });
        updateDisplay();
    }

    // Handle visibility change - recalculate time when tab becomes visible
    document.addEventListener('visibilitychange', () => {
        if (!document.hidden && isRunning && timerEndTime) {
            const now = Date.now();
            remainingTime = Math.max(0, Math.floor((timerEndTime - now) / 1000));
            updateDisplay();
            updateGlobalTimer();

            if (remainingTime <= 0) {
                timerComplete();
            }
        }
    });
</script>
{% endblock %}